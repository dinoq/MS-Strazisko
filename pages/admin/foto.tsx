import type { NextPage } from 'next'
import { withIronSession } from 'next-iron-session'
import Head from 'next/head'
import React, { useEffect, useState } from 'react'
import AppTable from '../../components/Table/Table'
import classes from './foto.module.scss'


enum ComponentTypes {
  INPUT,
  SELECTBOX
}

enum ShownLevel {
  YEARS,
  ALBUMS,
  PHOTOS
}

const AdminPhotosPage: NextPage = (props: any) => {
  const [breadcrumbItems, setBreadcrumbItems] = useState([]);
  const [yearEntries, setYearEntries] = useState([]);
  const [albumEntries, setAlbumEntries] = useState([]);
  const [photoEntries, setPhotoEntries] = useState([]);
  const [currentAlbum, setCurrentAlbum] = useState("")

  let shownLevel = (breadcrumbItems.length == 0) ? ShownLevel.YEARS : (breadcrumbItems.length == 1) ? ShownLevel.ALBUMS : ShownLevel.PHOTOS;

  useEffect(() => {
    fetch("/api/admin/years").then((resp) => {
      if (resp.status == 200) {
        resp.json().then((json) => {
          setYearEntries(json);
          console.log('json.albums: ', json);
        });
      } else {
        resp.text().then((value) => {
          console.log("tvalue: ", value);
        });
      }
    });
  }, []);

  const yearClicked = (year) => {
    fetch("/api/admin/getAlbums?year=" + year).then((resp) => {
      if (resp.status == 200) {
        resp.json().then((json) => {
          setAlbumEntries(json);
          console.log('json: ', json);
          setBreadcrumbItems(prevState => [...prevState, year]);
        });
      } else {
        resp.text().then((value) => {
          console.log("tvalue: ", value);
        });
      }
    });
  }

  const albumClicked = (album) => {
    setCurrentAlbum(album.title);
    fetch(
      "/api/admin/getPhotos?albumID=" + album.id,
      {method: "GET"}).then((resp) => {
      if (resp.status == 200) {
        resp.json().then((json) => {
          setPhotoEntries(json);
          setBreadcrumbItems(prevState => [...prevState, album.name]);
        });
      } else {
        resp.text().then((value) => {
          console.log("tvalue: ", value);
        });
      }
    });
  }


  const headerItems: Array<any> = getTableHeaderItems(breadcrumbItems.length);

  const bodyRows: Array<any> = getTableRows(breadcrumbItems.length, yearEntries, albumEntries, photoEntries, yearClicked, albumClicked, currentAlbum);

  const [newObjectManagerVisible, setNewObjectManagerVisible] = useState(false)

  const showNewObjectManager = () => {
    setNewObjectManagerVisible(true)
  }
  const hideNewObjectManager = () => {
    setNewObjectManagerVisible(false)
  }

  let title = (shownLevel == ShownLevel.YEARS) ? "Přidat nový školní rok" : (shownLevel == ShownLevel.ALBUMS) ? "Přidat nové album" : "Přidat fotky";
  let colspan = (headerItems.length) ? headerItems.length : 1;
  /*
  bodyRows.unshift({
    items: [{
        colspan,
        content: (<>
            {!newObjectManagerVisible && <span className={"link " + "add-document-btn mb-3"} onClick={showNewObjectManager}>{title}</span>}
            {newObjectManagerVisible && <NewObjectManager hideFileManager={hideNewObjectManager} />}
        </>),
        className: "text-center"
    }]
})
*/
  return (
    <div className={""}>
      <Head>
        <title>Stránky</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={""}>
        <Breadcrumb items={breadcrumbItems} setItems={setBreadcrumbItems} />

        <div className={"form-wrapper"}>
          {!newObjectManagerVisible && <span className={"link " + "add-document-btn mb-3"} onClick={showNewObjectManager}>{title}</span>}
          {newObjectManagerVisible && <NewObjectManager hideFileManager={hideNewObjectManager} headerItems={headerItems} shownLevel={shownLevel} />}
          <AppTable headerItems={headerItems} bodyRows={bodyRows} />
        </div>
      </main>
    </div>
  )
}


const getTableHeaderItems = (index) => {
  const getYears = () => {
    let years = [];
    let actualYear = new Date().getFullYear();
    for (let i = 0; i < 10; i++) {
      years.push((actualYear - i) + "/" + (actualYear + 1 - i));
    }
    return years;
  }
  if (index == 0) { // Years...
    return [
      { content: "Školní rok", editable: true, type: ComponentTypes.SELECTBOX, values: getYears() },
      { content: "Heslo", editable: true, type: ComponentTypes.INPUT, inputType: "password" },
      { content: "Akce" },
    ]
  } else if (index == 1) { // Albums
    return [
      { content: "ID" },
      { content: "Datum", editable: true, type: ComponentTypes.INPUT, inputType: "date" },
      { content: "URL", editable: true, type: ComponentTypes.INPUT, inputType: "text" },
      { content: "Název", editable: true, type: ComponentTypes.INPUT, inputType: "text" },
      { content: "Akce" },
    ]
  } else if (index == 2) { // Photos
    return [
      { content: "ID" },
      { content: "URL", editable: true, type: ComponentTypes.INPUT, inputType: "text" },
      { content: "Náhled" },
      { content: "Akce" },
    ]
  }
}


const getTableRows = (index, yearEntries, albumEntries, photoEntries, yearClicked, albumClicked, album) => {
  if (index == 0) { // Years...
    return yearEntries.map((entry, index) => {
      return ({
        items: [
          { content: <span onClick={yearClicked.bind(this, entry.year)}> {entry.year.replace("_", "/")} </span>, className: "link" },
          { content: entry.password },
          { className: "actions", content: (<><span className={"link-danger"} onClick={null}>Smazat</span><span className={"link"}>Přejmenovat</span></>) }
        ]
      })
    })

  } else if (index == 1) { // Albums
    return albumEntries.map((entry, index) => {
      let date = new Date(entry.date);

      return ({
        items: [
          { content: entry.id },
          { content: date.getDate() + ". " + (date.getMonth() + 1) + ". " + date.getFullYear() },
          { content: entry.title },
          { content: <span onClick={albumClicked.bind(this, entry)}> {entry.name} </span>, className: "link" },
          { className: "actions", content: (<><span className={"link-danger"} onClick={null}>Smazat</span><span className={"link"}>Přejmenovat</span></>) }
        ]
      })
    })

  } else if (index == 2) { // Photos
    return photoEntries.map((entry, index) => {
      console.log("ASD", entry.filename);
      return ({
        items: [
          { content: entry.id },
          { content: (<a href={"/api/getPhoto?file=" + album + "/" + entry.filename} target="_blank">{entry.filename}</a>), className: "link" },
          { content: <a href={"/api/getPhoto?file=" + album + "/" + entry.filename} target="_blank"><img className={classes.imgPreview} src={"/api/getPhoto?file=" + album + "/" + entry.filename + "&minify"} alt="Náhled obrázku" /></a> },
          { className: "actions", content: (<><span className={"link-danger"} onClick={null}>Smazat</span><span className={"link"}>Přejmenovat</span></>) }
        ]
      })
    })

  }
}

const Breadcrumb = (props) => {

  let items: [] = props.items ? props.items : [];

  const resetNav = () => {
    props.setItems([]);
  }

  const itemClicked = (index) => {
    props.setItems(prevState => {
      return prevState.slice(0, index + 1);
    });
  }
  return (
    <div className={classes.breadcrumb}>
      <span className={classes.breadcrumbItem + " link"} onClick={resetNav}>
        Foto
      </span>&nbsp;&gt;&nbsp;
      {items.map((item, index) => {
        return (
          <span key={"breadcrumb-item-" + index} className={""}>
            {index != 0 && " > "}
            <span className={classes.breadcrumbItem + " link"} onClick={itemClicked.bind(this, index)}>
              {item}
            </span>
          </span>
        )
      })}
    </div>
  )
}


const NewObjectManager = (props) => {
  const [fileLabel, setFileLabel] = useState("Vyberte soubor")
  const [file, setFile] = useState(null);
  const initFileName = "Název souboru";
  const [fileName, setFileName] = useState(initFileName);
  const [urlName, setUrlName] = useState("");

  const fileChange = (event) => {
    if (event?.target?.files[0]?.name?.length) {
      const f = event.target.files[0];
      setFile(f);
      setUrlName(f.name);
      setFileLabel("Vybráno: " + f.name);
      if (fileName === initFileName || fileName === "") {
        setFileName(f.name);
      }
    }
  }


  const formSubmitted = async (event) => {
    event.preventDefault();
    let level = props.shownLevel;
    console.log('level: ', level);
    let url = "";
    if (level == ShownLevel.YEARS) {
      url = "years";
    } else if (level == ShownLevel.ALBUMS) {
      url = "albums";
    } else if (level == ShownLevel.PHOTOS) {
      url = "photos";
    } else {
      return;
    }

    
    const body = new FormData();
    /*body.append("document", file);
    body.append("url", urlName);
    body.append("name", fileName);*/
    const response = await fetch("/api/admin/" + url, {
      method: "POST",
      body
    });

    if (response.status == 200) {
      window.location.reload();
    }
  };

  const fileNameChanged = (e) => {
    setFileName(e.target.value);
  }

  const clearFileName = (e) => {
    if (fileName === initFileName) {
      setFileName("");
    }
  }

  console.log("props.headerItems", props.headerItems);
  return (
    <div>
      <form className="d-flex flex-column bordered p-2 mb-3" onSubmit={formSubmitted}>

        {props.headerItems.map(((item, i) => {
          if (item.editable) {
            if (item.type == ComponentTypes.INPUT) {
              return (
                <div key={"input-" + i}>
                  <div className="d-flex justify-content-center">
                    <input type={item.inputType ? item.inputType : "text"} name="file-name" id="file-name" className={classes.fileName} placeholder={item.content} />
                  </div>
                </div>
              );
            } else if (item.type == ComponentTypes.SELECTBOX) {
              return (
                <select key={"selectbox-" + i} name="cars" id="cars">
                  {item.values.map((val, j) => {
                    return <option key={"selectbox-" + i + "-option-" + j} value={val}>{val}</option>
                  })}
                </select>
              );
            } else {
              return (
                <div key={"component-" + i}>

                </div>
              );
            }
          }
        }))}

        <div className="d-flex justify-content-center">
          <input className="button" type="submit" value="Uložit" />
          <input className="button button-danger" onClick={props.hideFileManager} type="button" value="Zrušit" />
        </div>
      </form>
    </div>
  )
}

export const getServerSideProps = withIronSession(
  async ({ req, res }) => {
    const adminLogged: Array<any> = req.session.get("adminLogged");

    if (adminLogged
    ) {
      return {
        props: {},
      };
    } else {
      return {
        redirect: {
          destination: '/admin/login',
          permanent: false,
        }
      };
    }
  },
  {
    cookieName: "myapp_cookiename",
    cookieOptions: {
      secure: process.env.NODE_ENV === "production" ? true : false,
    },
    password: "P5hBP4iHlvp6obqtWK0mNuMrZow5x6DQV61W3EUG",
  }
);

export default AdminPhotosPage
